function compile(a,b,c){if("function"==typeof b&&(c=b,b={}),b.filename&&(b.filename=path.resolve(b.filename)),b.cache){if(!b.filename)return c(new Error("The `filename` option is required for caching"));var d={};["filename","minify","includeSource","selfClosingTags","templateNamespace","basedir","middleware"].forEach(function(a){null!=b[a]&&(d[a]=b[a])}),d=JSON.stringify(d)}if(d&&cache[d])c(null,cache[d]);else{var e=new Compiler(a,b);e.compile(function(a,b){return a?c(a):(d&&(cache[d]=b),c(null,b),void 0)})}}function compileFile(a,b,c){"function"==typeof b&&(c=b,b={});var d={};for(var e in b)d[e]=b[e];if(d.filename=path.resolve(a),d.cache&&cache[d.filename])c(null,cache[d.filename]);else if(d.synchronous){try{var f=fs.readFileSync(a)}catch(g){return c(g)}compile(f.toString(),d,c)}else fs.readFile(a,function(a,b){return a?c(a):(compile(b.toString(),d,c),void 0)})}function renderFile(a,b,c){compileFile(a,b,function(a,d){if(a)return c(a);var e={},f=["locals","cb",b.templateNamespace||"__"];for(var g in b)f.indexOf(g)<0&&(e[g]=b[g]);d(e,c)})}function middleware(a,b){function e(a,b){if("function"==typeof a.assetFingerprint&&exports.version){var c=new Date;c.setFullYear(c.getFullYear()+1),a.assetFingerprint(b,b+"?v="+exports.version,{etag:exports.version,expires:c})}}b=b||{},b.mount=b.mount||"/views/","undefined"==typeof b.runtimeMount&&(b.runtimeMount="/blade/blade.js"),"undefined"==typeof b.pluginsMount&&(b.pluginsMount="/blade/plugins/"),"undefined"==typeof b.returnErrors&&(b.returnErrors="development"==process.env.NODE_ENV),null==b.compileOptions&&(b.compileOptions={cache:"production"==process.env.NODE_ENV,minify:"production"==process.env.NODE_ENV,includeSource:"development"==process.env.NODE_ENV}),a=path.resolve(a),b.compileOptions.basedir=a,b.compileOptions.middleware=!0;var c={},d=path.resolve(__dirname+"/../plugins/");return function(f,g,h){var i=url.parse(f.url).pathname;if(b.runtimeMount&&i==b.runtimeMount)c.runtime?g.type("application/javascript").send(c.runtime):fs.readFile(__dirname+"/runtime.js",function(a,b){return a?h(a):(b=bladeutil.uglify(b.toString(),!0),c.runtime=b,e(f,i),g.type("application/javascript").send(b),void 0)});else if(b.pluginsMount&&i.substr(0,b.pluginsMount.length)==b.pluginsMount){var j=path.normalize(i.substr(b.pluginsMount.length)),k=path.join(d,j);0!=k.indexOf(d)?g.type("text/plain").send("403 Forbidden",403):c[k]?g.type("application/javascript").send(c[k]):fs.readFile(k,function(a,b){return a?h(a):(b=bladeutil.uglify(b.toString(),!0),c[k]=b,e(f,i),g.type("application/javascript").send(b),void 0)})}else if(i.substr(0,b.mount.length)==b.mount){var j=path.normalize(i.substr(b.mount.length)),k=path.join(a,j);if(0!=k.indexOf(a))return g.type("text/plain").send("403 Forbidden",403);compileFile(k,b.compileOptions,function(a,c){g.type("application/javascript");var d=JSON.stringify(j.replace(path.sep,"/"));if(a)b.returnErrors?g.send("var e=blade._cb["+d+"];e&&e("+"new Error("+JSON.stringify(a.message)+"));"):h(a);else{for(var e=[],f=0;f<c.dependencies.length;f++)e[f]=c.dependencies[f].replace(path.sep,"/");g.send("blade._cachedViews["+d+"]="+c.toString()+";var e=blade._cb["+d+"];e&&e(null,"+JSON.stringify(c.reldir.replace(path.sep,"/"))+","+JSON.stringify(e)+","+c.unknownDependencies+");")}})}else h()}}var fs=require("fs"),path=require("path"),url=require("url"),Compiler=require("./compiler"),bladeutil=require("./util");try{exports.version=require("../package.json").version}catch(e){}exports.compile=compile,exports.compileFile=compileFile,exports.Compiler=Compiler,exports.renderFile=exports.__express=renderFile,exports.middleware=middleware,exports.readRuntime=function(){return fs.readFileSync(__dirname+"/runtime.js")};var cache={};
